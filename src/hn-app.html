<link rel="import" href="../bower_components/polymer/polymer-element.html">

<!-- iron elements -->
<link rel="import" href="../bower_components/iron-icon/iron-icon.html">
<link rel="import" href="../bower_components/iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../bower_components/iron-pages/iron-pages.html">
<!-- app elements -->
<link rel="import" href="../bower_components/app-layout/app-toolbar/app-toolbar.html">
<link rel="import" href="../bower_components/app-route/app-location.html">
<link rel="import" href="../bower_components/app-route/app-route.html">
<!-- our custom elements -->
<link rel="lazy-import" href="hn-story-list.html">
<link rel="lazy-import" href="hn-story.html">
<link rel="lazy-import" href="hn-user.html">
<link rel="import" href="hn-icons.html">

<dom-module id="hn-app">
  <template>
    <style>
      :host {
        display: block;
        height: 100%;
        margin: 0;
      }

      app-toolbar {
        background: #FF5722;
        color: #fff;
      }

      div[main-title] {
        @apply --layout-flex-auto;
        @apply --layout-horizontal;
        @apply --layout-center;
        @apply --layout-center-justified;
        text-decoration: none;
        color: white;
        margin-right: 40px;
      }

      .title {
        margin: 0;
        text-align: center;
        display: inline;
        margin-left: 20px;
        margin-right: 20px;
        transition: opacity 0.2s;
      }

      iron-icon {
        width: 30px;
        height: 30px;
      }
    </style>

    <app-location route="{{route}}"></app-location>
    <app-route
      route="{{route}}"
      pattern="[[rootPattern]]:page"
      data="{{routeData}}"
      tail="{{subroute}}"></app-route>

    <app-toolbar>
      <div main-title>
        <iron-icon icon="hn-icons:whatshot"></iron-icon>
        <span class="title">Hacker news</span>
      </div>
    </app-toolbar>
    <iron-pages
        selected="[[page]]"
        attr-for-selected="name"
        fallback-selection="404">
      <hn-story-list name="story-list" subroute="[[subroute]]"></hn-story-list>
      <hn-story name="story" subroute="[[subroute]]"></hn-story>
      <hn-user name="user" subroute="[[subroute]]"></hn-user>
    </iron-pages>
  </template>
  <script>
    class HnApp extends Polymer.Element {
      static get is() { return 'hn-app'; }
      static get properties() {
        return {
          page: {
            type: String,
            reflectToAttribute: true,
            observer: '_pageChanged'
          },
          rootPattern: String,
          routeData: Object,
          subroute: String,
        }
      }

      static get observers() {
        return [
          '_routePageChanged(routeData.page)',
        ];
      }

      constructor() {
        super();
        this.rootPattern = (new URL(this.rootPath)).pathname;
      }

      connectedCallback() {
        super.connectedCallback();
        // console.log('attached');
        const resolvedPageUrl = this.resolveUrl('hn-story-list.html');
        Polymer.importHref(resolvedPageUrl, null, '404', true);
      }

      _routePageChanged(page) {
        // Polymer 2.0 will call with `undefined` on initialization.
        // Ignore until we are properly called with a string.
        if (page === undefined) {
          return;
        }

        // If no page was found in the route data, page will be an empty string.
        // Deault to 'view1' in that case.
        this.page = page || 'story-list';

        document.body.scrollTop = 0;
      }

      _pageChanged(page) {
        // Load page import on demand. Show 404 page if fails
        var resolvedPageUrl = this.resolveUrl('hn-' + page + '.html');
        Polymer.importHref(
          resolvedPageUrl,
          null,
          this._showPage404.bind(this),
          true);
      }

      _showPage404() {
        this.page = '404';
      }
    };

    window.customElements.define(HnApp.is, HnApp);
  </script>
</dom-module>
